<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>InfoViso</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="/css/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="/css/bootstrap-responsive.min.css" rel="stylesheet">
<link href="/css/style.css" rel="stylesheet">

<script src="/socket.io/socket.io.js"></script>
<script src="/libraries/jquery-1.9.1.min.js"></script>
<script src="/libraries/bootstrap.min.js"></script>
<script src="/libraries/processing-1.4.1.min.js"></script>
<script src="/libraries/moment.min.js"></script>

<script type="text/javascript">

$(document).ready(function(){

    var sketch              = new Processing.Sketch();
    sketch.use3DContext     = true;
    var sketchWidth         = $(document).width();
    var sketchHeigth        = 540;
    var socket              = io.connect();  //globales io Object, des Servers, aufrufen
    var scale               = 1.00;
    var rotate              = 0.00;
    var yAchse              = 0.00;
    var xAchse              = 0.00;
    var yearBegin           = 1992;
    var yearEnd             = 2012;
    var amountRequest       = 0;
    var requestArray        = new Array();
    var currentRequest      = 0;
    var currentColor        = 0;

    var colorMap            = {
        '1': 0xFB2182B,
        '2': 0xFFDDBC7,
        '3': 0xF92C5DE,
        '4': 0xF053061,
        '5': 0xFABDDA4
    };

    // Der ColorMap die Funktion Size geben, um die Anzahl der Einträge zu erfahren.
    colorMap.size = function() {
        var size = 0, key;
        for (key in this) {
            if (this.hasOwnProperty(key) && key !== 'size') size++;
        }
        return size;
    };

    var processingObjectCreater = function () {
        var processingObject = {};
        var color =  colorMap[Math.floor((Math.random()*colorMap.size())+1)];

        for(var x = yearBegin; x <= yearEnd; x++){
            processingObject[x] = {
                '01' : 0,
                '02' : 0,
                '03' : 0,
                '04' : 0,
                '05' : 0,
                '06' : 0,
                '07' : 0,
                '08' : 0,
                '09' : 0,
                '10' : 0,
                '11' : 0,
                '12' : 0
            }
        };

        while (color === currentColor) {
            color = colorMap[Math.floor((Math.random()*colorMap.size())+1)];
        };
        console.log(color);
        processingObject.color = color;
        currentColor = color;

        requestArray[amountRequest] = processingObject;
        amountRequest++;
    };

    processingObjectCreater();

    // Daten senden für New York Times
    socket.emit('nyt', { content: 'Iraq', yearBegin: yearBegin, yearEnd: yearEnd });

    socket.on('nytResponse', function(data){
        // Test ob das ResponseObject gefüllt ist
        if(Object.keys( data.facets ).length !== 0){
            // processingObject mit Daten aus dem Response füllen
            for(var t = 0; t < data.facets.publication_month.length; t++){
                requestArray[currentRequest][data.tokens[1].substring(18,22)][data.facets.publication_month[t].term] =  data.facets.publication_month[t].count;
            }
        }
    });

    sketch.attachFunction = function(processing){

        processing.setup = function(){
            processing.size(sketchWidth,sketchHeigth, processing.P3D);
            processing.noStroke();
            processing.smooth();
        };

        processing.draw = function(){

            //processing.beginCamera();
            //processing.rotateX(processing.frameCount/100.0);
            //processing.endCamera();

            // Mittelpunkt für die Rotation setzten
            processing.translate(350,400,-800); // setzt das Koordinatensystem in die mitte
            processing.scale(scale);
            processing.rotateY(processing.radians(rotate));
            processing.translate(0,-yAchse);
            processing.translate(-xAchse,0);
            processing.background(237);
            processing.translate(-sketchWidth,550);

            var translateZ = 0;
            for(var i = 0; i < amountRequest; i++) {
                processing.pushMatrix();
                for(var y = yearBegin; y < yearEnd; y++ ){
                    // Jahreszahl ausgeben
                    processing.fill(1);
                    processing.text(y, 0, 10, 200, 200, 30);
                    $.each(requestArray[i][y], function(month, value){
                        processing.translate(20,0,0);
                        processing.stroke(153);
                        // Bug - https://processing-js.lighthouseapp.com/projects/41284/tickets/1976-alpha-value-in-fill-not-working-in-3d
                        processing.fill(requestArray[i].color,50);
                        processing.pushMatrix();
                        if(value != 0){
                            processing.translate(0,-value/2,translateZ);
                            processing.box(20,-value,20);
                         } else {
                            processing.translate(0,0,translateZ);
                            processing.box(20,-1,20);
                         }
                        processing.popMatrix();
                    });
                };
                processing.popMatrix();
                translateZ += 20;
            };

            var getColor = function () {

            }
        };
    };

    var canvas = document.getElementById("myCanvas");
    // attaching the sketch to the canvas
    var p = new Processing(canvas, sketch);

    $('#buttonPlus').click(function () {
        // ein neues processing Object erstellen und diesem eine zufällige Farbe aus der ColorMap zuweisen
        processingObjectCreater(colorMap[Math.floor((Math.random()*5)+1)]);

        $('#request-field').append("<div class='span3 input-append' style='margin-left: 20px; width: 260px;'>" +
                "<input id='searchID-" + String(amountRequest-1) + "' type='text'>" +
                "<button id='buttonID-" + String(amountRequest-1) + "' class='btn' type='button'><i class='icon-search'></i></button>" +
                "</div>");
        $("#buttonID-" + String(amountRequest-1)).click(createClickEvent(amountRequest-1, '#searchID-'+ String(amountRequest-1)));
    });

    $('#scale').change(function(){
        scale = this.value;
    });

    $('#rotate').change(function(){
        rotate = this.value;
    });

    $('#yAchse').change(function(){
        yAchse = this.value;
    });

    $('#xAchse').change(function(){
        xAchse = this.value;
    });

    var createClickEvent = function(arrayId, inputId) {
        return function () {
            var search = $(inputId).val();
            currentRequest = arrayId;
            // processingObject Werte auf null zurück setzten, damit die Werte aus dem vorigen Request
            // nicht mit genutzt werden, falls diese nicht überschrieben werden
            for(var y = yearBegin; y < yearEnd; y++ ){
                $.each(requestArray[arrayId][y], function(mounth, value){
                    requestArray[arrayId][y][mounth] = 0;
                });
            };
            socket.emit('nyt', { content: search, yearBegin: yearBegin, yearEnd: yearEnd });
        }
    };

    var getColor = function () {
        return colorMap[2];
    };

    $('#buttonInit').click(function(){
        currentRequest = 0;

        // processingObject Werte auf null zurück setzten, damit die Werte aus dem vorigen Request
        // nicht mit genutzt werden, falls diese nicht überschrieben werden
        for(var y = yearBegin; y < yearEnd; y++ ){
            $.each(requestArray[currentRequest][y], function(mounth, value){
                requestArray[currentRequest][y][mounth] = 0;
            });
        };

        // Daten senden
        if($('#inputInit').val() == ''){
            socket.emit('nyt', { content: 'Iraq', yearBegin: yearBegin, yearEnd: yearEnd});
        }
        else{
            socket.emit('nyt', { content: $('#inputInit').val(), yearBegin: yearBegin, yearEnd: yearEnd });
        };
    });
});

</script>
</head>
<body>
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <span class="brand" style="padding-left: 40px;">Informationsvisualisierung</span>
        <ul class="nav">
            <li class="active"><a href="#">App</a></li>
            <li><a href="#">Theorie</a></li>
            <li><a href="#">Code</a></li>
        </ul>
                <span class="text-right help-block" style="padding-right: 20px; padding-top: 10px;">
                    <smal>philipp.krehl@fh-stralsund.de</smal>
                </span>
    </div>
</div>
<div class="container-fluid" style="margin-top: 45px; padding: 0;">
    <div class="row-fluid">
        <div class="page-header" style="margin-bottom: 1px; margin-top: 5px;  padding-bottom: 5px;">
            <h2 style="margin-left: 10px">Querys <small> - Fragen von Interesse - </small> </h2>
        </div>
    </div>
    <div class="row-fluid">
        <div id="canvasContainer">
            <canvas id="myCanvas"></canvas>
        </div>
    </div>
    <div class="row-fluid" style="height: 70px;">
        <form>
            <fieldset id="request-field" style="width: 260px;">
                <div class="span3 input-append" style="margin-left: 20px;">
                    <label>Was sagt New York Times über:</label>
                    <input id="inputInit" type="text" placeholder="Irak">
                    <button id="buttonInit" class="btn" type="button"><i class="icon-search"></i></button>
                    <button id="buttonPlus" class="btn" type="button"><i class="icon-plus-sign"></i></button>
                </div>
            </fieldset>
        </form>
    </div>

    <div id="controlPanel">
        <span>Control Pannel:</span>
        <div>
            <i class="icon-zoom-in" style="margin-right: 10px; margin-left: 22px;"></i>
            <input id="scale" type="range" min="0.01" max="4.00" step="0.01" value='2.00'>
        </div>
        <div>
            <i class="icon-repeat" style="margin-right: 10px; margin-left: 22px;"></i>
            <input id="rotate" type="range" min="1" max="360" step="1" value='0'>
        </div>
        <div>
            <i class="icon-arrow-down" style="margin-right: 10px;"></i><i class="icon-arrow-up" style="margin-right: 10px"></i>
            <input id="yAchse" type="range" min="-1000" max="700" step="1" value='300'>
        </div>
        <div>
            <i class="icon-arrow-left" style="margin-right: 10px;"></i><i class="icon-arrow-right" style="margin-right: 10px"></i>
            <input id="xAchse" type="range" min="-1000" max="3200" step="1" value='0'>
        </div>
    </div>

</div>
</body>
</html>