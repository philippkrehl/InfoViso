<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>InfoViso</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="/css/bootstrap-responsive.min.css" rel="stylesheet">

    <script src="/socket.io/socket.io.js"></script>
    <script src="/libraries/jquery-1.9.1.min.js"></script>
    <script src="/libraries/bootstrap.min.js"></script>
    <script src="/libraries/processing-1.4.1.min.js"></script>
    <script src="/libraries/moment.min.js"></script>
    <script src="/libraries/jquery.overscroll.min.js"></script>

    <script type="text/javascript">
        var yearBegin           = 1992;
        var yearEnd             = 2012;

        $(document).ready(function(){

            var sketch              = new Processing.Sketch();
            sketch.use3DContext     = true;
            var sketchWidth         = $(window).width();
            var sketchHeigth        = 440;
            var socket              = io.connect();  //globales io Object, des Servers, aufrufen
            var scale               = 1.00;
            var rotate              = 0.00;
            var processingObject    = {
                                        'zeit' : {},
                                        'nyt'  : {}
                                      };

            for(var x = yearBegin; x < yearEnd+1; x++){
                processingObject.zeit[x] = {
                    '01' : 0,
                    '02' : 0,
                    '03' : 0,
                    '04' : 0,
                    '05' : 0,
                    '06' : 0,
                    '07' : 0,
                    '08' : 0,
                    '09' : 0,
                    '10' : 0,
                    '11' : 0,
                    '12' : 0
                };

                processingObject.nyt[x] = {
                    '01' : 0,
                    '02' : 0,
                    '03' : 0,
                    '04' : 0,
                    '05' : 0,
                    '06' : 0,
                    '07' : 0,
                    '08' : 0,
                    '09' : 0,
                    '10' : 0,
                    '11' : 0,
                    '12' : 0
                }
            }

            // Daten senden für Zeit online
            socket.emit('zeit', { content: 'Irak' });

            // Daten empfangen von Zeit online
            socket.on('zeitResponse', function(data){
                // die per Request ermittelten Werte im processingObject speichern,
                // nach dem Muster Jahr == Jahr und Monat == Monat
                $.each(data.facets.release_date, function(date, value){
                    if(date !== 'start' && date !== 'end' && date !== 'gap') {
                        processingObject.zeit[Number(moment(date).format('YYYY'))][moment(date).format('MM')] = value;
                    }

                });
                console.log(processingObject);
            });

            // Daten senden für New York Times
            // Intervall, weil die NYT ein Limit gesetzt hat, auf die Anzahl der Reqeust per Sec.
            socket.emit('nyt', { content: 'Iraq', yearBegin: yearBegin, yearEnd: yearEnd });

            socket.on('nytResponse', function(data){
                // Test ob das ResponseObject gefüllt ist
                if(Object.keys( data.facets ).length !== 0){
                    // processingObject mit Daten aus dem Response füllen
                    for(var t = 0; t < data.facets.publication_month.length; t++){
                        processingObject.nyt[data.tokens[1].substring(18,22)][data.facets.publication_month[t].term] =  data.facets.publication_month[t].count;
                    }
                }
            });

            sketch.attachFunction = function(processing){

                processing.setup = function(){
                    processing.size(sketchWidth,sketchHeigth, processing.P3D);
                    processing.noStroke();
                    processing.smooth();
                };

                processing.draw = function(){
                    //processing.size(sketchWidth,sketchHeigth, processing.P3D);
                    //processing.pushMatrix();
                    processing.translate(sketchWidth/2,0);
                    processing.scale(scale);
                    processing.rotateY(processing.radians(rotate));
                    //processing.popMatrix();

                    processing.background(241, 241, 241);
                    processing.translate(0,sketchHeigth);

                    //drawYear(processing,processingObject);
                    //processing.fill(132,121,212);
                    //processing.translate(58, 48, 12);
                    //processing.rotateY(0.5);
                    //draw2(processing,processingObject);

                    processing.pushMatrix();
                    processing.translate(-sketchWidth/2,0);
                    for(var t = yearBegin; t < yearEnd; t++ ){
                        processing.pushMatrix();
                        $.each(processingObject.nyt[t], function(month, value){
                            processing.translate(10,0,0);
                            processing.stroke(153);
                            processing.fill(221,209,163,20);
                            processing.pushMatrix();
                            if(value != 0){
                                processing.translate(0,-value/2,0);
                                processing.box(10,-value,10);
                            } else {
                                processing.translate(0,0,0);
                                processing.box(10,-1,10);
                            }
                            processing.popMatrix();
                        });
                        processing.popMatrix();
                        $.each(processingObject.zeit[t], function(month, value){
                            processing.translate(10,0);
                            processing.stroke(153);
                            processing.fill(121,109,63);
                            processing.pushMatrix();
                            if(value != 0){
                                processing.translate(0,-value/2,10);
                                processing.box(10,-value,10);
                            } else{
                                processing.translate(0,0,10);
                                processing.box(10,-1,10);
                            }
                            processing.popMatrix();
                        });
                    };
                    processing.popMatrix();
                };
            };

            var canvas = document.getElementById("myCanvas");
            // attaching the sketch to the canvas
            var p = new Processing(canvas, sketch);

            $('#zeitButton').click(function(){
                // processingObject Werte auf null zurück setzten, damit die Werte aus dem vorigen Request
                // nicht mit genutzt werden, falls diese nicht überschrieben werden
                for(var y = yearBegin; y < yearEnd+1; y++){
                    $.each(processingObject.zeit[y], function(month, value){
                        processingObject.zeit[y][month] = 0;
                    });
                };

                // Daten senden
                if($('#zeitInput').val() == ''){
                    socket.emit('zeit', { content: 'Irak' });
                }
                else{
                    socket.emit('zeit', { content: $('#zeitInput').val() });
                };
            });

            $('#nytButton').click(function(){
                // processingObject Werte auf null zurück setzten, damit die Werte aus dem vorigen Request
                // nicht mit genutzt werden, falls diese nicht überschrieben werden
                for(var y = yearBegin; y < yearEnd+1; y++){
                    $.each(processingObject.nyt[y], function(mounth, value){
                        processingObject.nyt[y][mounth] = 0;
                    });
                };

                // Daten senden
                if($('#nytInput').val() == ''){
                    socket.emit('nyt', { content: 'Iraq', yearBegin: yearBegin, yearEnd: yearEnd});
                }
                else{
                    socket.emit('nyt', { content: $('#nytInput').val(), yearBegin: yearBegin, yearEnd: yearEnd });
                };
            });

            $('#scale').change(function(){
                scale = this.value;
            });

            $('#rotate').change(function(){
                rotate = this.value;
            });
        });

        function drawYear(processing, processingObject){
            var drawWeigthNYT  = 0;
            var drawWeigthZeit = 0;
            var barWeight      = 10

            var temp = Object.keys(processingObject.nyt).length;
            for(var t = yearBegin; t < yearEnd; t++ ){
                $.each(processingObject.nyt[t], function(month, value){
                    processing.pushMatrix();
                    processing.translate(drawWeigthNYT,processing.height/2);
                    processing.fill(224,209,163,190);
                    processing.rect(0,0,barWeight,-value);
                    drawWeigthNYT += barWeight;
                    processing.popMatrix();
                });

                $.each(processingObject.zeit[t], function(month, value){
                    processing.pushMatrix();
                    processing.translate(drawWeigthZeit,processing.height/2);
                    processing.fill(124,109,233,190);
                    processing.rect(0,0,barWeight,value);
                    drawWeigthZeit += barWeight;
                    processing.popMatrix();
                })


            };
        };

        function draw2 (processing, processingObject){
            var barWeight      = 10

            var temp = Object.keys(processingObject.nyt).length;
            for(var t = yearBegin; t < yearEnd; t++ ){
                $.each(processingObject.nyt[t], function(month, value){
                    processing.stroke(153);
                    processing.fill(224,209,163,190);
                    processing.box(10,value,10);
                });
            };
        };

    </script>
</head>
<body>
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <span class="brand" style="padding-left: 40px;">Informationsvisualisierung</span>
        <ul class="nav">
            <li class="active"><a href="#">App</a></li>
            <li><a href="#">Theorie</a></li>
            <li><a href="#">Code</a></li>
        </ul>
                <span class="text-right help-block" style="padding-right: 20px; padding-top: 10px;">
                    <smal>philipp.krehl@fh-stralsund.de</smal>
                </span>
    </div>
</div>
<div class="container-fluid" style="margin-top: 45px; padding: 0;">
    <div class="row-fluid">
        <div class="page-header" style="margin-bottom: 10px; margin-top: 5px;  padding-bottom: 5px;">
            <h2 style="margin-left: 10px">Querys <small> - Fragen von Interesse - </small> </h2>
        </div>
    </div>
    <div class="row-fluid" style="height: 70px;">
        <form>
            <fieldset>
                <div class="span3 input-append" style="margin-left: 20px;">
                    <label>Was sagt Zeit Online über:</label>
                    <input id="zeitInput" type="text" placeholder="Irak">
                    <button id="zeitButton" class="btn" type="button">Go!</button>

                </div>
                <div class="span3 input-append">
                    <label>Was sagt New York Times über:</label>
                    <input id="nytInput" type="text" placeholder="Iraq">
                    <button id="nytButton" class="btn" type="button">Go!</button>
                </div>
                <div class="span2">
                    <label>Scalierung:</label>
                    <input id="scale" type="range" min="0.01" max="4.00" step="0.01" value='2.00'>
                </div>
                <div class="span2">
                    <label>Rotate:</label>
                    <input id="rotate" type="range" min="1" max="360" step="1" value='0'>
                </div>
            </fieldset>
        </form>
    </div>
    <div class="row-fluid">
        <div id="canvasContainer">
            <canvas id="myCanvas"></canvas>
        </div>
    </div>
</div>
</body>
</html>